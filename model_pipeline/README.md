# MLflow Model System - Customer Churn Prediction

A production-ready MLOps system for training, evaluating, and managing ML models for customer churn prediction using MLflow.

## Overview

This project implements a complete MLOps pipeline for customer churn prediction using:

- **MLflow** for experiment tracking, model registry, and artifact management
- **Multiple ML Models** (XGBoost, Logistic Regression, Random Forest, Decision Tree)
- **MinIO** for S3-compatible artifact storage
- **Kubernetes** for MLflow deployment
- **Feast** for feature store integration

## Project Structure

```plaintext
model_pipeline/
├── README.md
└── src/
    ├── config/
    │   ├── xgboost.yaml              # XGBoost model configuration
    │   ├── logistic_regression.yaml  # Logistic Regression configuration
    │   ├── random_forest.yaml        # Random Forest configuration
    │   └── decision_tree.yaml        # Decision Tree configuration
    ├── mlflow_utils/
    │   ├── experiment_tracker.py     # MLflow experiment management
    │   └── model_registry.py         # Model registry operations
    ├── model/
    │   ├── xgboost_trainer.py        # Generic trainer for all models
    │   └── evaluator.py              # Model evaluation logic
    ├── scripts/
    │   ├── train.py                  # Training script
    │   ├── eval.py                   # Evaluation script
    │   ├── register_model.py         # Model registry CLI
    │   └── compare_models.py         # Model comparison script
    ├── run_sh/
    │   ├── train.sh                  # Training execution script
    │   ├── eval.sh                   # Evaluation execution script
    │   ├── register.sh               # Model registration script
    │   ├── compare.sh                # Model comparison script
    │   ├── set_model_alias.sh        # Set model alias
    │   ├── promote.sh                # Promote model to champion
    │   ├── list_model.sh             # List registered models
    │   └── model_info.sh             # Get model information
    ├── tests/
    │   ├── unit/
    │   └── integration/
    └── utility/
        └── helper.py                 # Utility functions
```

## Prerequisites

- **Python**: 3.10 or higher
- **kubectl**: For accessing MLflow on Kubernetes
- **CUDA** (optional): For GPU-accelerated XGBoost training

## Accessing MLflow UI

MLflow is deployed on Kubernetes. To access the UI:

```bash
# Run the port-forward script
./infra/k8s/access-mlflow.sh
```

This will forward the MLflow service to `http://localhost:5000`. Press `Ctrl+C` to stop.

## Configuration

### Config Files

Each model type has its own configuration file in `src/config/`:

| Config File | Model Type | Description |
|-------------|------------|-------------|
| `xgboost.yaml` | XGBoost | Gradient boosting classifier |
| `logistic_regression.yaml` | Logistic Regression | Linear classifier |
| `random_forest.yaml` | Random Forest | Ensemble tree classifier |
| `decision_tree.yaml` | Decision Tree | Single tree classifier |

### Example Config Structure

```yaml
mlflow:
  tracking_uri: "http://localhost:5000"
  experiment_name: "test_churn_prediction_v0.1"
  artifact_location: "s3://mlflow/"
  tags:
    task: "churn_prediction"
    purpose: "test"

model:
  name: "xgboost_churn"
  type: "classifier"
  model_type: "xgboost"  # or "logistic_regression", "random_forest", "decision_tree"
  train_test_split: 0.2
  random_state: 42
  parameters:
    # Model-specific parameters

evaluation:
  thresholds:
    accuracy: 0.85
    auc: 0.80

features:
  target_column: churned
  training_features:
    - age
    - gender
    - tenure_months
    # ... more features
```

## Quick Start

### 1. Access MLflow UI

```bash
./infra/k8s/access-mlflow.sh
```

### 2. Train a Model

```bash
cd model_pipeline/src/run_sh

# Train with default config (logistic regression)
./train.sh

# Train with specific config
./train.sh --config ../config/xgboost.yaml

# Train with custom run name
./train.sh --config ../config/xgboost.yaml --run-name "xgboost_experiment_1"
```

**train.sh Options:**

```plaintext
--config PATH              Path to config YAML
--training-data-path PATH  Path to training data
--run-name NAME            Run name (default: autogenerated)
--python-script PATH       Path to training script
-h, --help                 Show help message
```

**Output**: The training script will output a `run_id` that you'll need for evaluation and registration.

### 3. Evaluate the Model

```bash
# Evaluate using run ID from training
./eval.sh --run-id <RUN_ID>

# Evaluate with specific config
./eval.sh --run-id <RUN_ID> --config ../config/xgboost.yaml

# Disable threshold validation
./eval.sh --run-id <RUN_ID> --no-validate-thresholds
```

**eval.sh Options:**

```plaintext
--run-id RUN_ID                 MLflow run ID to evaluate (required)
--config PATH                   Path to config YAML
--eval-data-path PATH           Path to evaluation dataset
--output-path-prediction PATH   Path to save predictions
--no-validate-thresholds        Disable threshold validation
-h, --help                      Show help message
```

### 4. Register the Model

```bash
# Register model from a training run
./register.sh register --run-id <RUN_ID> --model-name churn-model

# With description
./register.sh register --run-id <RUN_ID> --model-name churn-model --description "XGBoost churn model v1"
```

**register.sh Commands:**

```plaintext
register    Register a model from an MLflow run
set-alias   Set an alias for a model version
promote     Promote a model to production
list        List all registered models
info        Get info about a model
```

**register.sh Options:**

```plaintext
--config PATH       Path to config YAML
--run-id ID         MLflow run ID (for register)
--model-name NAME   Model name
--version VER       Model version (for set-alias, promote)
--alias ALIAS       Alias: staging|champion|production (for set-alias)
--description DESC  Model description (for register)
```

### 5. Set Model Alias

```bash
# Set staging alias
./set_model_alias.sh --model-name churn-model --version 1 --alias staging

# Set champion alias
./set_model_alias.sh --model-name churn-model --version 1 --alias champion
```

### 6. Promote to Production

```bash
# Promote model from staging to champion
./promote.sh --model-name churn-model --version 1
```

### 7. List and Inspect Models

```bash
# List all registered models
./list_model.sh

# Get detailed info about a model
./model_info.sh
```

## Python Scripts Direct Usage

### train.py

```bash
cd model_pipeline
export PYTHONPATH=$(pwd)

python src/scripts/train.py \
  --config src/config/xgboost.yaml \
  --training-data-path /path/to/train.parquet \
  --experiment-name "my_experiment" \
  --run-name "my_run"
```

**Arguments:**

- `--config`: Path to config YAML file
- `--training-data-path`: Path to training data (CSV or Parquet)
- `--experiment-name`: MLflow experiment name (optional, uses config default)
- `--run-name`: MLflow run name (optional)

### eval.py

```bash
python src/scripts/eval.py \
  --config src/config/xgboost.yaml \
  --run-id <RUN_ID> \
  --eval-data-path /path/to/test.parquet \
  --validate-thresholds \
  --output-path-prediction predictions.csv
```

**Arguments:**

- `--config`: Path to config YAML file
- `--run-id`: MLflow run ID to evaluate
- `--model-uri`: Alternative to run-id, e.g., `models:/model_name@champion`
- `--eval-data-path`: Path to evaluation data (CSV or Parquet)
- `--validate-thresholds`: Validate metrics against configured thresholds
- `--compare-baseline`: Baseline model URI to compare against
- `--output-path-prediction`: Path to save predictions CSV

### register_model.py

```bash
# Register a model
python src/scripts/register_model.py --config src/config/config.yaml \
  register \
  --run-id <RUN_ID> \
  --model-name churn-model \
  --artifact-path model \
  --description "My model"

# Set alias
python src/scripts/register_model.py --config src/config/config.yaml \
  set-alias \
  --model-name churn-model \
  --version 1 \
  --alias staging

# Promote to champion
python src/scripts/register_model.py --config src/config/config.yaml \
  promote \
  --model-name churn-model \
  --version 1

# List models
python src/scripts/register_model.py --config src/config/config.yaml list

# Get model info
python src/scripts/register_model.py --config src/config/config.yaml \
  info \
  --model-name churn-model
```

## Model Registry Workflow

```plaintext
┌─────────────────┐
│    Training     │  ./train.sh
│  (Creates Run)  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   Evaluation    │  ./eval.sh --run-id <RUN_ID>
│ (Validate Run)  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Registration   │  ./register.sh register --run-id <RUN_ID> --model-name <NAME>
│(Create Version) │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│    Staging      │  ./set_model_alias.sh --alias staging
│   (Testing)     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   Production    │  ./promote.sh --model-name <NAME> --version <VER>
│   (Champion)    │
└─────────────────┘
```

## Loading Models

```python
import mlflow

# Load from run ID
model = mlflow.pyfunc.load_model(f"runs:/{run_id}/model_name")

# Load from registry by version
model = mlflow.pyfunc.load_model("models:/churn-model/1")

# Load from registry by alias
model = mlflow.pyfunc.load_model("models:/churn-model@staging")
model = mlflow.pyfunc.load_model("models:/churn-model@champion")

# Make predictions
predictions = model.predict(test_data)
```

## Environment Variables

The scripts automatically set these environment variables for MinIO/S3 access:

```bash
AWS_ACCESS_KEY_ID=minio
AWS_SECRET_ACCESS_KEY=minio123
AWS_DEFAULT_REGION=us-east-1
MLFLOW_S3_ENDPOINT_URL=http://localhost:9000
```

## Data Sources

Training and evaluation data is sourced from the Feast feature store:

- **Training data**: `data-pipeline/churn_feature_store/churn_features/feature_repo/data/processed_churn_data.parquet`
- **Test data**: `data-pipeline/churn_feature_store/churn_features/feature_repo/data/test.parquet`

## Architecture

```plaintext
┌─────────────────────────────────────────────────────────────┐
│                   MLflow UI (Port 5000)                     │
│              Experiment Tracking & Model Registry           │
└───────────────────────────┬─────────────────────────────────┘
                            │
            ┌───────────────┼───────────────┐
            │               │               │
            ▼               ▼               ▼
┌──────────────────┐ ┌──────────────┐ ┌──────────────────┐
│    PostgreSQL    │ │    MinIO     │ │  Training/Eval   │
│    (Metadata)    │ │  (Artifacts) │ │    Scripts       │
└──────────────────┘ └──────────────┘ └──────────────────┘
                            │
                            ▼
                    ┌──────────────┐
                    │    Feast     │
                    │ Feature Store│
                    └──────────────┘
```

## Module Overview

| Module | Description |
|--------|-------------|
| `mlflow_utils/experiment_tracker.py` | Handles MLflow run lifecycle, logging params/metrics/artifacts |
| `mlflow_utils/model_registry.py` | Model versioning, aliases, promotion |
| `model/xgboost_trainer.py` | Generic trainer supporting multiple model types |
| `model/evaluator.py` | Evaluation metrics, threshold validation |
| `utility/helper.py` | Config loading and utility functions |
